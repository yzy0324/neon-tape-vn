export function mkPortrait(grid) {
  const palette = {
    '0':'#140a24','1':'#ffd8c1','2':'#f7b08f','3':'#56f0ff','4':'#ff5aaa','5':'#bc71ff','6':'#3a205f','7':'#131326','8':'#ffed77','9':'#9ee7ff','a':'#ff9b4a'
  };
  const size = 16;
  let rects = '';
  grid.forEach((row, y) => row.forEach((c, x) => { if (c !== '0') rects += `<rect x="${x}" y="${y}" width="1" height="1" fill="${palette[c]}" />`; }));
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${size} ${size}' shape-rendering='crispEdges'>${rects}</svg>`;
  return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
}

const zeroGrid = [
['0','0','0','0','3','3','3','3','3','3','0','0','0','0','0','0'],['0','0','0','3','5','5','6','6','6','5','5','3','0','0','0','0'],['0','0','3','5','6','2','2','2','2','2','6','5','3','0','0','0'],['0','3','5','6','2','2','2','2','2','2','2','6','5','3','0','0'],['0','3','5','6','1','1','2','2','2','1','1','6','5','3','0','0'],['0','3','5','6','1','7','2','2','2','7','1','6','5','3','0','0'],['0','3','5','6','1','1','2','2','2','1','1','6','5','3','0','0'],['0','0','3','5','6','2','8','8','8','2','6','5','3','0','0','0'],['0','0','0','3','5','6','6','6','6','6','5','3','0','0','0','0'],['0','0','0','0','3','5','5','5','5','5','3','0','0','0','0','0'],['0','0','0','0','3','9','9','9','9','9','3','0','0','0','0','0'],['0','0','0','3','9','9','9','9','9','9','9','3','0','0','0','0'],['0','0','3','9','9','9','3','0','0','3','9','9','3','0','0','0'],['0','3','9','9','9','3','0','0','0','0','3','9','9','9','3','0'],['0','3','9','9','3','0','0','0','0','0','0','3','9','9','3','0'],['0','0','3','3','0','0','0','0','0','0','0','0','3','3','0','0']
];
const liaisonGrid = [
['0','0','0','0','4','4','4','4','4','4','0','0','0','0','0','0'],['0','0','0','4','5','5','5','6','6','5','5','4','0','0','0','0'],['0','0','4','5','6','6','2','2','2','2','6','5','4','0','0','0'],['0','4','5','6','2','2','2','2','2','2','2','6','5','4','0','0'],['0','4','5','6','2','1','1','2','2','1','1','6','5','4','0','0'],['0','4','5','6','2','1','7','2','2','7','1','6','5','4','0','0'],['0','4','5','6','2','1','1','2','2','1','1','6','5','4','0','0'],['0','0','4','5','6','2','8','8','8','2','6','5','4','0','0','0'],['0','0','0','4','5','6','6','6','6','6','5','4','0','0','0','0'],['0','0','0','0','4','4','5','5','5','4','4','0','0','0','0','0'],['0','0','0','0','3','3','3','3','3','3','3','0','0','0','0','0'],['0','0','0','3','9','9','9','9','9','9','9','3','0','0','0','0'],['0','0','3','9','9','9','3','0','0','3','9','9','3','0','0','0'],['0','3','9','9','9','3','0','0','0','0','3','9','9','9','3','0'],['0','3','9','9','3','0','0','0','0','0','0','3','9','9','3','0'],['0','0','3','3','0','0','0','0','0','0','0','0','3','3','0','0']
];
const hackerGrid = zeroGrid;
const detectiveGrid = [
['0','0','0','0','3','3','3','3','3','3','0','0','0','0','0','0'],['0','0','0','3','6','6','5','5','5','6','6','3','0','0','0','0'],['0','0','3','6','2','2','2','2','2','2','2','6','3','0','0','0'],['0','3','6','2','2','2','2','2','2','2','2','2','6','3','0','0'],['0','3','6','2','1','1','2','2','2','1','1','2','6','3','0','0'],['0','3','6','2','1','7','2','2','2','7','1','2','6','3','0','0'],['0','3','6','2','1','1','2','2','2','1','1','2','6','3','0','0'],['0','0','3','6','2','2','8','8','8','2','2','6','3','0','0','0'],['0','0','0','3','6','2','2','2','2','2','6','3','0','0','0','0'],['0','0','0','0','3','6','6','6','6','6','3','0','0','0','0','0'],['0','0','0','0','a','a','a','a','a','a','a','0','0','0','0','0'],['0','0','0','a','a','a','a','a','a','a','a','a','0','0','0','0'],['0','0','a','a','a','a','3','0','0','3','a','a','a','0','0','0'],['0','a','a','a','a','3','0','0','0','0','3','a','a','a','a','0'],['0','a','a','a','3','0','0','0','0','0','0','3','a','a','a','0'],['0','0','a','a','0','0','0','0','0','0','0','0','a','a','0','0']
];

export const cast = {
  zero: { name: '零磁（你）', desc: '夜班调酒师，中立情报站维护员。', img: mkPortrait(zeroGrid) },
  liaison: { name: '绫濑雾音｜企业联络官', desc: '云穹生物的对外联络官，强调“合作才有明天”。', img: mkPortrait(liaisonGrid) },
  hacker: { name: '烬线｜街头黑客', desc: '从排风管和旧网格里捞真相的人。', img: mkPortrait(hackerGrid) },
  detective: { name: '韩铬｜义体警探', desc: '城市执法组的义体侦缉官，偏好可执行方案。', img: mkPortrait(detectiveGrid) }
};

export const scenes = {
  s00: { title:'开场：太阳雨夜班', speaker:'zero', bg:'bar', text:()=>'22:11，酸雨沿着酒吧霓虹玻璃流成一条条发光裂缝。你擦干吧台，听见磁带机咔哒一声倒带。今晚的值班名单很短，但系统里的“匿名点单”连续跳了三次：同一串加密前缀，分别来自企业网、街区暗网、执法内网。\n\n你知道这意味着什么：公司、黑客、执法三方会在同一晚把你当作中继站。每个人都想让你给出第一杯酒，也想让你先听他们的版本。',
    choices:[{text:'先把后厨监控和通风管线全开，按流程准备。',effect:{logic:1,preserve:1},next:'s01'},{text:'调高音乐和霓虹，先稳住气氛再见客。',effect:{emotion:1,coop:1},next:'s01'}]},
  s01: { title:'节点一：企业联络官的点单', speaker:'liaison', bg:'corp', text:()=>'绫濑雾音准点坐到吧台尽头，银色风衣上没有一滴雨。她点了一杯“无糖极昼”，把一枚公司认证币推到你面前。\n\n“今夜的数据塔会发生泄漏。”她说，“我们可以出钱、出豁免、出保护，只要你把可疑流量先交给我。若消息先落到街头，恐慌会先杀人。”\n\n她把说辞讲得像投资报告：风险、收益、回撤，一样不少。',
    choices:[{text:'追问她愿意公开到什么程度，要求写入可审计条款。',effect:{logic:1,oppose:1},next:'s02'},{text:'先接受合作意向，换取本区停电期间的药品配额。',effect:{coop:1,preserve:1},next:'s02'}]},
  s02: { title:'节点二：街头黑客的暗号', speaker:'hacker', bg:'alley', text:()=>'后门卷帘被敲出三短两长，烬线抱着旧键盘箱进来，点单是“热盐黑咖+绝缘泡沫”。他把键帽掀开，里面是被拆成碎片的记忆改写日志。\n\n“公司只会给你修饰后的真相。”烬线低声说，“我可以把原始包拼回去，但你得决定：要精确证据，还是要先护住人心。”\n\n他看起来疲惫，却还在笑，像每个通宵后的黎明前五分钟。',
    choices:[{text:'让他按时间戳重组并校验哈希，先看硬证据。',effect:{logic:1,explore:1},next:'s03'},{text:'先听他讲受害者故事，再决定公开节奏。',effect:{emotion:1,coop:1},next:'s03'}]},
  s03: { title:'节点三：义体警探到场', speaker:'detective', bg:'street', text:()=>'警探韩铬带着雨水和金属摩擦声走进来，他的左眼镜片投出实时城市热图。点单很简单：常温水。\n\n“我不替谁站台，”他说，“但今晚若有人把整城电网推下去，死的先是重症病房。”他把一份临时执法令放到吧台：允许你申请封锁部分频道，也允许你拒绝。\n\n他问你的不是立场，而是你是否准备好承担后果。',
    choices:[{text:'申请最小范围封锁，优先保全生命线设施。',effect:{preserve:1,coop:1},next:'s04'},{text:'拒绝预封锁，保留信息流动和现场证词。',effect:{explore:1,oppose:1},next:'s04'}]},
  s04: { title:'中段：后厨拼图', speaker:'zero', bg:'backroom', text:(st)=>`你把三方数据并到同一台离线终端。屏幕上跳出同一个计划代号“回声井”，目标是通过饮料订阅系统筛选“可管理情绪人群”。\n\n你忽然意识到，酒吧不是边角建筑，而是城市神经末梢。每一杯点单都在喂养某个预测模型。\n\n${st.score.logic>=st.score.emotion?'你本能地先写下时间线，开始做交叉验证。':'你先记下每个名字和他们的恐惧，担心数字掩盖了人。'}`,
    choices:[{text:'把证据拆成三份，分别通知三方到场对质。',effect:{coop:1,logic:1},next:'s05'},{text:'仅保留一份主密钥，先由你单线推进。',effect:{oppose:1,explore:1},next:'s05'}]},
  s05: { title:'中段回扣①：理性 / 感性', speaker:'hacker', bg:'bar', text:(st)=> st.score.logic>=st.score.emotion
    ? '烬线看着你整理出的流程图，点头：“好，没人能说你伪造。”他把自己的情绪压到最低，只按证据说话。可你也察觉到，几位受害者家属在门外等着，怕自己会被“再等等”挡回去。'
    : '你让受害者语音在吧台里悄悄播放。烬线沉默了很久：“这比任何图表都重。”他提醒你，一旦没有技术护栏，企业法务会反咬你“煽动”。你知道自己正在拿共情去赌时效。',
    choices:[{text:'补齐另一侧短板：加入更多技术或人证。',effect:{logic:1,emotion:1},next:'s06'},{text:'坚持当前路径，争取更快推进。',effect:{preserve:1},next:'s06'}]},
  s06: { title:'中段回扣②：合作 / 对抗', speaker:'liaison', bg:'corp', text:(st)=> st.score.coop>=st.score.oppose
    ? '雾音带来了临时谈判桌和法律见证人，愿意把“回声井”部分权限交由第三方托管。她强调这是你此前持续合作换来的窗口期。'
    : '雾音身后站着安保无人机，语气冷下来：“你若执意公开，我们会按最高等级处置泄密。”你先前的强硬让她改走压制路线。',
    choices:[{text:'提出停火条件：公开审计+街区代表席位。',effect:{coop:1,logic:1},next:'s07'},{text:'当场反制：把谈判内容同步给地下电台。',effect:{oppose:1,emotion:1},next:'s07'}]},
  s07: { title:'中后段：巡逻线外', speaker:'detective', bg:'street', text:(st)=> st.score.explore>=st.score.preserve
    ? '韩铬把你带到高架桥下的废弃节点。你们找到一组离线备份，里面记录着更早期的实验对象。探索让你拿到更全的真相，但也意味着你们错过了宵禁前的安全窗口。'
    : '韩铬优先护送你回到酒吧安全区，沿途关闭了三条高风险线路。你保住了队伍与证据，却失去了一部分流向未知节点的追踪线索。',
    choices:[{text:'继续深挖备份源头，哪怕延后公开。',effect:{explore:1,logic:1},next:'s08'},{text:'先整理现有证据并发布风险提示。',effect:{preserve:1,coop:1},next:'s08'}]},
  s08: { title:'终段前夜：点单高峰', speaker:'zero', bg:'bar', text:()=>'凌晨 01:40，酒吧像临时作战室。企业法务、街区志愿者、巡逻队员轮流点单，每杯饮料都夹带一句请求。\n\n你一边调酒一边分发密钥片段：有人要稳定、有人要爆破、有人只想活着见到天亮。磁带机循环播放同一句旁白——“选择不是纯粹正确，而是承担某种代价。”',
    choices:[{text:'把完整密钥交给三方联合看管。',effect:{coop:1,preserve:1},next:'s09'},{text:'将密钥拆散后广播给民间节点。',effect:{oppose:1,explore:1},next:'s09'}]},
  s09: { title:'终段：回扣③与终局抉择', speaker:'zero', bg:'dawn', text:(st)=>`天色将亮未亮。你回看整夜日志：\n- 理性/感性：${st.score.logic}/${st.score.emotion}\n- 合作/对抗：${st.score.coop}/${st.score.oppose}\n- 探索/保守：${st.score.explore}/${st.score.preserve}\n\n三条倾向都在此刻回扣：你如何理解真相、如何面对权力、如何选择风险边界，将共同决定这座城的早晨。`,
    choices:[{text:'先回看整晚日志并确认发布窗口。',effect:{logic:1,preserve:1},next:'s10'},{text:'趁混乱直接推进，抢在各方之前出手。',effect:{emotion:1,explore:1},next:'s10'}]},
  s10: { title:'终局走廊：三方最后通话', speaker:'liaison', bg:'corp', text:(st)=>`雾音、烬线、韩铬同时接入你的耳机频道。三个人都在倒计时。

${st.score.coop>=st.score.oppose?'因为你维持了基本合作，三方还愿意在同一个协议页上签字。':'因为你多次对抗强权，三方此刻互不信任，只剩你做唯一中继。'}

你必须决定最终密钥的托管方式。`,
    choices:[{text:'设立联合托管并附公开审计。',effect:{coop:1,logic:1},next:'s11'},{text:'拒绝中心托管，转向民间分布式。',effect:{oppose:1,explore:1},next:'s11'}]},
  s11: { title:'终局前一分钟', speaker:'detective', bg:'dawn', text:(st)=>`${st.score.explore>=st.score.preserve?'韩铬替你挡住追兵，争取到上传窗口；你知道这一步会让秩序短时失稳。':'韩铬优先疏散街区，要求你按阈值发布；你知道这会牺牲部分爆炸性真相。'}

磁带机转到最后十秒，吧台灯光由紫转橙。你按下发送键。`,
    choices:[{text:'迎接黎明。',effect:{logic:1},next:'END'}]}
};
